openapi: 3.0.3
info:
  title: GCSE Mobile Auth API
  version: 1.0.0
  description: Mobile authentication endpoints for the GCSE app.
servers:
  - url: https://gcse-quiz-997951122924.europe-west1.run.app
paths:
  /api/v1/me:
    get:
      summary: Get current user profile
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Current profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      summary: Update current user profile settings
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfilePatchRequest'
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Premium required for multiple subjects
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/me/subjects:
    put:
      summary: Update active subjects and complete onboarding
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubjectsUpdateRequest'
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Premium required for multiple subjects
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/subscription/identify:
    post:
      summary: Store RevenueCat app user id for the current user
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RevenueCatIdentifyRequest'
      responses:
        '200':
          description: RevenueCat app user id stored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevenueCatIdentifyResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/subscription/sync:
    post:
      summary: Sync subscription state from RevenueCat
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Subscription synced
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevenueCatSyncResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: RevenueCat sync failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/subscription/webhook:
    post:
      summary: RevenueCat webhook callback
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: RevenueCat webhook payload.
      responses:
        '200':
          description: Webhook processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevenueCatWebhookResponse'
        '400':
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/register:
    post:
      summary: Register a mobile user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: Registration successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidUsername:
                  summary: Invalid username format
                  value:
                    error: Username must be 5-15 characters
                profaneUsername:
                  summary: Profane username
                  value:
                    error: Username is not allowed
        '409':
          description: Email or username already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                linkRequired:
                  summary: OAuth link required
                  value:
                    error: An account already exists with this email. Do you want to link Apple sign-in and replace your password login?
                    code: oauth_link_required
              examples:
                linkRequired:
                  summary: OAuth link required
                  value:
                    error: An account already exists with this email. Do you want to link Google sign-in and replace your password login?
                    code: oauth_link_required
              examples:
                emailTaken:
                  summary: Email already in use
                  value:
                    error: Email already in use
                usernameTaken:
                  summary: Username already in use
                  value:
                    error: Username already in use
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/login:
    post:
      summary: Login with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid email or password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/username/check:
    get:
      summary: Check if a username is available
      parameters:
        - in: query
          name: username
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Availability response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsernameCheckResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/username/update:
    post:
      summary: Update the current user's username
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UsernameUpdateRequest'
      responses:
        '200':
          description: Username updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsernameUpdateResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidUsername:
                  summary: Invalid username format
                  value:
                    error: Username must be 5-15 characters
                profaneUsername:
                  summary: Profane username
                  value:
                    error: Username is not allowed
        '401':
          description: Missing or invalid session token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Must wait 30 days before changing username again
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                cooldown:
                  summary: Username change cooldown window
                  value:
                    error: Must wait 30 days before changing username again
        '409':
          description: Username already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/account/delete/request:
    post:
      summary: Request account deletion (email/password only)
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Deletion request created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeletionRequestResponse'
        '400':
          description: Validation error or not supported for OAuth accounts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Deletion already scheduled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/account/delete/confirm:
    post:
      summary: Confirm account deletion (email/password only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeletionConfirmRequest'
      responses:
        '200':
          description: Deletion confirmed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeletionConfirmResponse'
        '400':
          description: Validation error or invalid code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Deletion already confirmed or cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '410':
          description: Code expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Too many attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/account/delete/cancel/request:
    post:
      summary: Request cancellation of scheduled deletion (email/password only)
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Cancellation request created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeletionRequestResponse'
        '400':
          description: Validation error or not supported for OAuth accounts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: No pending deletion to cancel
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/account/delete/cancel/confirm:
    post:
      summary: Confirm deletion cancellation (email/password only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeletionConfirmRequest'
      responses:
        '200':
          description: Cancellation confirmed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeletionConfirmResponse'
        '400':
          description: Validation error or invalid code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Cancellation already confirmed or already cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '410':
          description: Code expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Too many attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/subscription/verify:
    post:
      summary: Verify a subscription purchase and unlock premium access
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscriptionVerifyRequest'
      responses:
        '200':
          description: Subscription status after verification
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionVerifyResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/admin/account-deletion/run:
    post:
      summary: Run account deletion job (cron)
      parameters:
        - in: header
          name: x-cron-secret
          required: true
          schema:
            type: string
          description: Shared secret for Cloud Scheduler.
      responses:
        '200':
          description: Job run summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeletionJobResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/admin/subscription-override:
    post:
      summary: Set admin override for a mobile user (backend-only)
      parameters:
        - in: header
          name: Authorization
          required: true
          schema:
            type: string
          description: Google ID token (`Bearer <token>`) with Cloud Run Invoker access.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminOverrideRequest'
      responses:
        '200':
          description: Admin override updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminOverrideResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/streak:
    get:
      summary: Get streak status for a subject or overall + all subjects
      parameters:
        - in: query
          name: subject
          required: false
          schema:
            $ref: '#/components/schemas/StreakSubject'
        - in: query
          name: timezone
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Streak status response
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/StreakStatus'
                  - $ref: '#/components/schemas/StreaksResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      summary: Streak actions (use freeze, update timezone)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StreakActionRequest'
      responses:
        '200':
          description: Action result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StreakActionResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/oauth/google:
    post:
      summary: Login or register with Google OAuth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OAuthRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid OAuth token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidToken:
                  summary: Invalid OAuth token
                  value:
                    error: Invalid OAuth token
        '409':
          description: Email or username already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/oauth/apple:
    post:
      summary: Login or register with Apple OAuth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OAuthRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid OAuth token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidToken:
                  summary: Invalid OAuth token
                  value:
                    error: Invalid OAuth token
        '409':
          description: Email or username already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    RegisterRequest:
      type: object
      required:
        - email
        - password
        - username
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 1
        username:
          type: string
          minLength: 5
          maxLength: 15
          pattern: '^[A-Za-z0-9_]+$'
          description: Must be 5-15 chars and not contain profanity.
    LoginRequest:
      oneOf:
        - type: object
          required:
            - email
            - password
          properties:
            email:
              type: string
              format: email
            password:
              type: string
              minLength: 1
        - type: object
          required:
            - username
            - password
          properties:
            username:
              type: string
              minLength: 5
              maxLength: 15
              pattern: '^[A-Za-z0-9_]+$'
            password:
              type: string
              minLength: 1
    UsernameUpdateRequest:
      type: object
      required:
        - username
      properties:
        username:
          type: string
          minLength: 5
          maxLength: 15
          pattern: '^[A-Za-z0-9_]+$'
          description: Must be 5-15 chars and not contain profanity.
    OAuthRequest:
      type: object
      required:
        - idToken
      properties:
        idToken:
          type: string
        username:
          type: string
          description: Required the first time a user logs in with OAuth. Must be 5-15 chars and not contain profanity.
          minLength: 5
          maxLength: 15
          pattern: '^[A-Za-z0-9_]+$'
        linkExisting:
          type: boolean
          description: Set true to link OAuth to an existing email/password account.
    AuthResponse:
      type: object
      required:
        - success
        - token
        - username
      properties:
        success:
          type: boolean
        token:
          type: string
          description: JWT used in Authorization: Bearer <token>.
        username:
          type: string
    UsernameCheckResponse:
      type: object
      required:
        - available
      properties:
        available:
          type: boolean
        reason:
          type: string
          nullable: true
    UsernameUpdateResponse:
      type: object
      required:
        - success
        - token
        - username
      properties:
        success:
          type: boolean
        token:
          type: string
        username:
          type: string
    DeletionRequestResponse:
      type: object
      required:
        - requestId
        - expiresAt
      properties:
        requestId:
          type: string
        expiresAt:
          type: string
          format: date-time
    DeletionConfirmRequest:
      type: object
      required:
        - requestId
        - code
      properties:
        requestId:
          type: string
        code:
          type: string
          minLength: 6
          maxLength: 6
          pattern: '^[0-9]{6}$'
    DeletionConfirmResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
    DeletionJobResponse:
      type: object
      required:
        - processed
        - deleted
        - errors
      properties:
        processed:
          type: integer
        deleted:
          type: integer
        errors:
          type: integer
    SubscriptionVerifyRequest:
      type: object
      required:
        - provider
      properties:
        provider:
          type: string
          enum: [apple, google]
        transactionId:
          type: string
          description: Apple transaction ID (required if appReceipt is not provided).
        appReceipt:
          type: string
          description: Apple app receipt (optional if transactionId is provided).
        purchaseToken:
          type: string
          description: Google Play purchase token (required for Google).
        packageName:
          type: string
          description: Android package name (required if not configured on the backend).
    SubscriptionVerifyResponse:
      type: object
      required:
        - entitlement
        - subscriptionStatus
        - subscriptionStart
        - subscriptionExpiry
        - graceUntil
        - subscriptionProvider
        - adminOverride
      properties:
        entitlement:
          $ref: '#/components/schemas/Entitlement'
        subscriptionStatus:
          $ref: '#/components/schemas/SubscriptionStatus'
        subscriptionStart:
          type: string
          nullable: true
          format: date-time
        subscriptionExpiry:
          type: string
          nullable: true
          format: date-time
        graceUntil:
          type: string
          nullable: true
          format: date-time
        subscriptionProvider:
          type: string
          nullable: true
        productId:
          type: string
          nullable: true
        store:
          type: string
          nullable: true
        environment:
          type: string
          nullable: true
        revenueCatAppUserId:
          type: string
          nullable: true
        lastRevenueCatEventId:
          type: string
          nullable: true
        adminOverride:
          type: boolean
    RevenueCatIdentifyRequest:
      type: object
      required:
        - revenueCatAppUserId
      properties:
        revenueCatAppUserId:
          type: string
    RevenueCatIdentifyResponse:
      type: object
      required:
        - revenueCatAppUserId
      properties:
        revenueCatAppUserId:
          type: string
    RevenueCatSyncResponse:
      type: object
      required:
        - revenueCatAppUserId
        - entitlement
        - subscriptionStatus
        - subscriptionStart
        - subscriptionExpiry
        - graceUntil
        - subscriptionProvider
      properties:
        revenueCatAppUserId:
          type: string
        entitlement:
          $ref: '#/components/schemas/Entitlement'
        subscriptionStatus:
          $ref: '#/components/schemas/SubscriptionStatus'
        subscriptionStart:
          type: string
          nullable: true
          format: date-time
        subscriptionExpiry:
          type: string
          nullable: true
          format: date-time
        graceUntil:
          type: string
          nullable: true
          format: date-time
        subscriptionProvider:
          type: string
          nullable: true
        productId:
          type: string
          nullable: true
        store:
          type: string
          nullable: true
        environment:
          type: string
          nullable: true
    RevenueCatWebhookResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
    AdminOverrideRequest:
      type: object
      required:
        - adminOverride
      properties:
        userId:
          type: string
          description: Optional if email is provided.
        email:
          type: string
          format: email
          description: Optional if userId is provided.
        adminOverride:
          type: boolean
          description: Set true to unlock all subjects for the user.
      description: Provide either userId or email to target a user.
    AdminOverrideResponse:
      type: object
      required:
        - userId
        - adminOverride
      properties:
        userId:
          type: string
        adminOverride:
          type: boolean
    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
        code:
          type: string
          nullable: true
          description: Optional machine-readable error code.
    SubjectsUpdateRequest:
      type: object
      required:
        - activeSubjects
      properties:
        activeSubjects:
          type: array
          minItems: 1
          maxItems: 3
          items:
            $ref: '#/components/schemas/ActiveSubject'
    ProfilePatchRequest:
      type: object
      properties:
        activeSubjects:
          type: array
          maxItems: 3
          items:
            $ref: '#/components/schemas/ActiveSubject'
        onboardingComplete:
          type: boolean
    ProfileResponse:
      type: object
      required:
        - id
        - activeSubjects
        - onboardingComplete
      properties:
        id:
          type: string
        username:
          type: string
          nullable: true
        activeSubjects:
          type: array
          items:
            $ref: '#/components/schemas/ActiveSubject'
        onboardingComplete:
          type: boolean
        entitlement:
          $ref: '#/components/schemas/Entitlement'
        subscriptionStatus:
          $ref: '#/components/schemas/SubscriptionStatus'
        subscriptionStart:
          type: string
          format: date-time
          nullable: true
        subscriptionExpiry:
          type: string
          format: date-time
          nullable: true
        graceUntil:
          type: string
          format: date-time
          nullable: true
        subscriptionProvider:
          type: string
          nullable: true
        adminOverride:
          type: boolean
    ActiveSubject:
      type: string
      enum:
        - Biology
        - Chemistry
        - Computer Science
    Entitlement:
      type: string
      enum:
        - premium
        - free
    SubscriptionStatus:
      type: string
      enum:
        - active
        - grace
        - expired
        - unknown
    StreakSubject:
      type: string
      enum:
        - overall
        - computer-science
        - biology
        - chemistry
    StreakStatus:
      type: object
      required:
        - currentStreak
        - freezeDays
        - maxFreezes
        - streakActive
        - daysUntilStreakLoss
        - frozeToday
      properties:
        currentStreak:
          type: integer
        freezeDays:
          type: integer
        maxFreezes:
          type: integer
        streakActive:
          type: boolean
        lastActivityDate:
          type: string
          nullable: true
        daysUntilStreakLoss:
          type: integer
        frozeToday:
          type: boolean
    StreaksResponse:
      type: object
      required:
        - overallStreak
        - streaks
      properties:
        overallStreak:
          $ref: '#/components/schemas/StreakStatus'
        streaks:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/StreakStatus'
    StreakActionRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          enum:
            - use_freeze
            - update_timezone
        subject:
          $ref: '#/components/schemas/StreakSubject'
        timezone:
          type: string
    StreakActionResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        streak:
          type: object
          properties:
            currentStreak:
              type: integer
            freezeDays:
              type: integer
        status:
          $ref: '#/components/schemas/StreakStatus'
