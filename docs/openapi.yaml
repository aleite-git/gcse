openapi: 3.0.3
info:
  title: GCSE Mobile Auth API
  version: 1.0.0
  description: Mobile authentication endpoints for the GCSE app.
servers:
  - url: https://gcse-quiz-997951122924.europe-west1.run.app
paths:
  /api/v1/me:
    get:
      summary: Get current user profile
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Current profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      summary: Update current user profile settings
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfilePatchRequest'
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/me/subjects:
    put:
      summary: Update active subjects and complete onboarding
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubjectsUpdateRequest'
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/register:
    post:
      summary: Register a mobile user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: Registration successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidUsername:
                  summary: Invalid username format
                  value:
                    error: Username must be 5-15 characters
                profaneUsername:
                  summary: Profane username
                  value:
                    error: Username is not allowed
        '409':
          description: Email or username already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                emailTaken:
                  summary: Email already in use
                  value:
                    error: Email already in use
                usernameTaken:
                  summary: Username already in use
                  value:
                    error: Username already in use
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/login:
    post:
      summary: Login with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid email or password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/username/check:
    get:
      summary: Check if a username is available
      parameters:
        - in: query
          name: username
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Availability response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsernameCheckResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/username/update:
    post:
      summary: Update the current user's username
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UsernameUpdateRequest'
      responses:
        '200':
          description: Username updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsernameUpdateResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidUsername:
                  summary: Invalid username format
                  value:
                    error: Username must be 5-15 characters
                profaneUsername:
                  summary: Profane username
                  value:
                    error: Username is not allowed
        '401':
          description: Missing or invalid session token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Must wait 30 days before changing username again
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                cooldown:
                  summary: Username change cooldown window
                  value:
                    error: Must wait 30 days before changing username again
        '409':
          description: Username already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/oauth/google:
    post:
      summary: Login or register with Google OAuth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OAuthRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid OAuth token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidToken:
                  summary: Invalid OAuth token
                  value:
                    error: Invalid OAuth token
        '409':
          description: Email or username already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/mobile/oauth/apple:
    post:
      summary: Login or register with Apple OAuth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OAuthRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid OAuth token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidToken:
                  summary: Invalid OAuth token
                  value:
                    error: Invalid OAuth token
        '409':
          description: Email or username already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    RegisterRequest:
      type: object
      required:
        - email
        - password
        - username
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 1
        username:
          type: string
          minLength: 5
          maxLength: 15
          pattern: '^[A-Za-z0-9_]+$'
          description: Must be 5-15 chars and not contain profanity.
    LoginRequest:
      oneOf:
        - type: object
          required:
            - email
            - password
          properties:
            email:
              type: string
              format: email
            password:
              type: string
              minLength: 1
        - type: object
          required:
            - username
            - password
          properties:
            username:
              type: string
              minLength: 5
              maxLength: 15
              pattern: '^[A-Za-z0-9_]+$'
            password:
              type: string
              minLength: 1
    UsernameUpdateRequest:
      type: object
      required:
        - username
      properties:
        username:
          type: string
          minLength: 5
          maxLength: 15
          pattern: '^[A-Za-z0-9_]+$'
          description: Must be 5-15 chars and not contain profanity.
    OAuthRequest:
      type: object
      required:
        - idToken
      properties:
        idToken:
          type: string
        username:
          type: string
          description: Required the first time a user logs in with OAuth. Must be 5-15 chars and not contain profanity.
          minLength: 5
          maxLength: 15
          pattern: '^[A-Za-z0-9_]+$'
    AuthResponse:
      type: object
      required:
        - success
        - token
        - username
      properties:
        success:
          type: boolean
        token:
          type: string
          description: JWT used in Authorization: Bearer <token>.
        username:
          type: string
    UsernameCheckResponse:
      type: object
      required:
        - available
      properties:
        available:
          type: boolean
        reason:
          type: string
          nullable: true
    UsernameUpdateResponse:
      type: object
      required:
        - success
        - token
        - username
      properties:
        success:
          type: boolean
        token:
          type: string
        username:
          type: string
    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
    SubjectsUpdateRequest:
      type: object
      required:
        - activeSubjects
      properties:
        activeSubjects:
          type: array
          minItems: 1
          maxItems: 3
          items:
            $ref: '#/components/schemas/ActiveSubject'
    ProfilePatchRequest:
      type: object
      properties:
        activeSubjects:
          type: array
          maxItems: 3
          items:
            $ref: '#/components/schemas/ActiveSubject'
        onboardingComplete:
          type: boolean
    ProfileResponse:
      type: object
      required:
        - id
        - activeSubjects
        - onboardingComplete
      properties:
        id:
          type: string
        username:
          type: string
          nullable: true
        activeSubjects:
          type: array
          items:
            $ref: '#/components/schemas/ActiveSubject'
        onboardingComplete:
          type: boolean
    ActiveSubject:
      type: string
      enum:
        - Biology
        - Chemistry
        - Computer Science
